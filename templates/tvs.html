{% extends 'base.html' %}
{% load static %}

{% block title %}TVs - NexaAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tvs.css' %}">
{% endblock %}

{% block content %}
<div class="tv-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-title-section">
            <h1 class="page-title">
                <i class="bi bi-tv"></i>
                Smart TVs
            </h1>
            <p class="page-subtitle">Control your LG webOS TVs and sync with lights</p>
        </div>
        <div class="page-actions">
            <a href="{% url 'models:tv_add' %}" class="btn-primary">
                <i class="bi bi-plus-lg"></i> Add TV
            </a>
        </div>
    </div>

    <!-- TV Grid -->
    <div class="tv-grid">
        {% for tv in tvs %}
        <div class="tv-card" data-tv-id="{{ tv.id }}">
            <div class="tv-card-header">
                <div class="tv-info">
                    <h3 class="tv-name">{{ tv.name }}</h3>
                    <span class="tv-model">{{ tv.model|default:"LG webOS TV" }}</span>
                </div>
                <div class="tv-status {% if tv.state.power == 'on' %}on{% else %}off{% endif %}">
                    <span class="status-dot"></span>
                    {{ tv.state.power|default:"Unknown"|title }}
                </div>
            </div>

            <div class="tv-card-body">
                <div class="tv-details">
                    <div class="detail-row">
                        <span class="detail-label">IP Address</span>
                        <span class="detail-value">{{ tv.ip_address }}</span>
                    </div>
                    {% if tv.location %}
                    <div class="detail-row">
                        <span class="detail-label">Location</span>
                        <span class="detail-value">{{ tv.location }}</span>
                    </div>
                    {% endif %}
                    {% if tv.state.power == 'on' %}
                    <div class="detail-row">
                        <span class="detail-label">Volume</span>
                        <span class="detail-value">{{ tv.state.volume|default:"--" }}%</span>
                    </div>
                    {% if tv.state.current_app %}
                    <div class="detail-row">
                        <span class="detail-label">Current App</span>
                        <span class="detail-value">{{ tv.state.current_app }}</span>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>

                <!-- Power Control -->
                <div class="tv-controls">
                    <button class="btn-power {% if tv.state.power == 'on' %}on{% else %}off{% endif %}" 
                            onclick="toggleTVPower('{{ tv.id }}')">
                        <i class="bi bi-power"></i>
                        {% if tv.state.power == 'on' %}Turn Off{% else %}Turn On{% endif %}
                    </button>
                </div>

                <!-- Volume Control (only when on) -->
                {% if tv.state.power == 'on' %}
                <div class="volume-control">
                    <span class="volume-label">Volume</span>
                    <input type="range" class="volume-slider" min="0" max="100" 
                           value="{{ tv.state.volume|default:50 }}"
                           onchange="setTVVolume('{{ tv.id }}', this.value)">
                    <span class="volume-value">{{ tv.state.volume|default:50 }}%</span>
                </div>
                {% endif %}

                <!-- Light Sync -->
                <div class="light-sync-section">
                    <div class="sync-header">
                        <span class="sync-label">
                            <i class="bi bi-link-45deg"></i> Light Sync
                        </span>
                        <label class="toggle-switch">
                            <input type="checkbox" {% if tv.auto_sync_enabled %}checked{% endif %}
                                   onchange="toggleAutoSync('{{ tv.id }}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    {% if tv.linked_lights %}
                    <span class="sync-info">{{ tv.linked_lights|length }} light(s) linked</span>
                    {% else %}
                    <span class="sync-info">No lights linked</span>
                    {% endif %}
                    <button class="btn-link-lights" onclick="openLinkLightsModal('{{ tv.id }}')">
                        <i class="bi bi-gear"></i> Configure
                    </button>
                </div>
            </div>

            <div class="tv-card-footer">
                {% if not tv.client_key %}
                <a href="{% url 'models:tv_pair' tv.id %}" class="btn-secondary btn-sm">
                    <i class="bi bi-link"></i> Pair
                </a>
                {% endif %}
                <a href="{% url 'models:tv_edit' tv.id %}" class="btn-icon" title="Edit">
                    <i class="bi bi-pencil"></i>
                </a>
                <button class="btn-icon btn-danger" onclick="deleteTV('{{ tv.id }}')" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="bi bi-tv"></i>
            <h3>No TVs Added</h3>
            <p>Add your LG webOS TV to control it and sync with your lights.</p>
            <a href="{% url 'models:tv_add' %}" class="btn-primary" style="padding: 0.75rem 1.5rem !important; font-size: 0.9rem !important; display: inline-flex !important; width: auto !important; height: auto !important; max-height: 50px !important; align-self: center !important;">
                <i class="bi bi-plus-lg"></i> Add TV
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Link Lights Modal -->
<div id="linkLightsModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bi bi-link-45deg"></i> Link Lights to TV</h3>
            <button class="modal-close" onclick="closeLinkLightsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Select lights to automatically turn on/off with the TV:</p>
            <div id="lightsCheckboxList" class="lights-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeLinkLightsModal()">Cancel</button>
            <button class="btn-primary" onclick="saveLinkLights()">Save</button>
        </div>
    </div>
</div>

<script>
let currentTVId = null;

function toggleTVPower(tvId) {
    fetch(`/api/tv/${tvId}/power/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ action: 'toggle' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to show updated state
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Error: ' + (data.error || 'Failed to control TV'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to control TV');
    });
}

function setTVVolume(tvId, volume) {
    fetch(`/api/tv/${tvId}/volume/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ volume: parseInt(volume) })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Error: ' + (data.error || 'Failed to set volume'));
        }
    });
}

function toggleAutoSync(tvId, enabled) {
    fetch(`/tv/${tvId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `auto_sync_enabled=${enabled ? 'on' : ''}`
    });
}

function openLinkLightsModal(tvId) {
    currentTVId = tvId;
    
    // Fetch available lights
    fetch('/api/lights/')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('lightsCheckboxList');
        container.innerHTML = '';
        
        if (data.lights && data.lights.length > 0) {
            data.lights.forEach(light => {
                const div = document.createElement('div');
                div.className = 'light-checkbox-item';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" value="${light.id}" class="light-checkbox">
                        <span>${light.name}</span>
                        <small>${light.room || ''}</small>
                    </label>
                `;
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p>No lights available. Add lights first.</p>';
        }
        
        document.getElementById('linkLightsModal').style.display = 'flex';
    });
}

function closeLinkLightsModal() {
    document.getElementById('linkLightsModal').style.display = 'none';
    currentTVId = null;
}

function saveLinkLights() {
    const checkboxes = document.querySelectorAll('.light-checkbox:checked');
    const lightIds = Array.from(checkboxes).map(cb => cb.value);
    
    fetch(`/api/tv/${currentTVId}/link-lights/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ light_ids: lightIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeLinkLightsModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to link lights'));
        }
    });
}

function deleteTV(tvId) {
    if (confirm('Are you sure you want to delete this TV?')) {
        window.location.href = `/tv/${tvId}/delete/`;
    }
}

// Refresh TV states periodically
setInterval(() => {
    document.querySelectorAll('.tv-card').forEach(card => {
        const tvId = card.dataset.tvId;
        fetch(`/api/tv/${tvId}/state/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const statusEl = card.querySelector('.tv-status');
                const power = data.state.power;
                statusEl.className = `tv-status ${power}`;
                statusEl.innerHTML = `<span class="status-dot"></span> ${power.charAt(0).toUpperCase() + power.slice(1)}`;
            }
        });
    });
}, 10000);
</script>
{% endblock %}
