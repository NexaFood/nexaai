{% extends "base.html" %}

{% block title %}View Model - NexaAI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <a href="/history" class="text-purple-600 hover:text-purple-700 mb-2 inline-flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back to History
                </a>
                <h1 class="text-4xl font-bold">{{ model.prompt|truncatewords:10 }}</h1>
            </div>
            <div class="flex space-x-3">
                {% if model.glb_url %}
                <a href="{{ model.glb_url }}" download class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download GLB</span>
                </a>
                {% endif %}
                {% if model.obj_url %}
                <a href="{{ model.obj_url }}" download class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download OBJ</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 3D Viewer -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div id="viewer-container" class="relative" style="height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 z-10">
                        <div class="text-center text-white">
                            <div class="spinner mx-auto mb-4"></div>
                            <p class="text-lg">Loading 3D model...</p>
                        </div>
                    </div>
                    <canvas id="viewer-canvas" class="w-full h-full"></canvas>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200">
                    <div class="flex items-center justify-between text-sm text-gray-600">
                        <span>üñ±Ô∏è Left click + drag to rotate</span>
                        <span>üñ±Ô∏è Right click + drag to pan</span>
                        <span>üñ±Ô∏è Scroll to zoom</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Info -->
        <div class="space-y-6">
            <!-- Details Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Model Details</h2>
                <div class="space-y-3">
                    <div>
                        <div class="text-sm text-gray-500">Status</div>
                        <div class="font-semibold">
                            {% if model.status == 'completed' %}
                                <span class="text-green-600">‚úì Completed</span>
                            {% elif model.status == 'processing' %}
                                <span class="text-blue-600">‚è≥ Processing</span>
                            {% elif model.status == 'failed' %}
                                <span class="text-red-600">‚úó Failed</span>
                            {% else %}
                                <span class="text-gray-600">{{ model.status }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Created</div>
                        <div class="font-semibold">{{ model.created_at|date:"M d, Y H:i" }}</div>
                    </div>
                    {% if model.art_style %}
                    <div>
                        <div class="text-sm text-gray-500">Art Style</div>
                        <div class="font-semibold capitalize">{{ model.art_style }}</div>
                    </div>
                    {% endif %}
                    <div>
                        <div class="text-sm text-gray-500">Quality</div>
                        <div class="font-semibold capitalize">{{ model.quality|default:"Preview" }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Prompt Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Original Prompt</h2>
                <p class="text-gray-700 leading-relaxed">{{ model.prompt }}</p>
            </div>
            
            <!-- Actions Card -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Actions</h2>
                <div class="space-y-3">
                    <a href="/generate?prompt={{ model.prompt|urlencode }}" class="block w-full bg-purple-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-purple-700 transition text-center">
                        Regenerate
                    </a>
                    <button 
                        hx-delete="/api/models/{{ model.id }}" 
                        hx-confirm="Are you sure you want to delete this model?"
                        hx-target="body"
                        class="block w-full bg-red-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-red-700 transition text-center"
                    >
                        Delete Model
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    
    // Three.js 3D Viewer
    let scene, camera, renderer, controls, model;
    
    function initViewer() {
        const container = document.getElementById('viewer-container');
        const canvas = document.getElementById('viewer-canvas');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        
        // Camera - increased far plane for large models
        camera = new THREE.PerspectiveCamera(
            75,
            container.clientWidth / container.clientHeight,
            0.01,  // Reduced near plane for close-up views
            10000  // Increased far plane for large models
        );
        camera.position.set(0, 0, 5);
        
        // Renderer
        renderer = new THREE.WebGLRenderer({ 
            canvas: canvas,
            antialias: true 
        });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        
        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight1.position.set(5, 5, 5);
        scene.add(directionalLight1);
        
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-5, -5, -5);
        scene.add(directionalLight2);
        
        // Controls - will be configured after model loads
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 0.1;  // Allow very close zoom
        controls.maxDistance = 1000; // Allow very far zoom
        
        // Load model via proxy to avoid CORS issues
        const modelUrl = "/api/models/{{ model.id }}/glb";
        console.log('Loading model from proxy:', modelUrl);
        if (modelUrl) {
            const loader = new GLTFLoader();
            loader.load(
                modelUrl,
                function(gltf) {
                    model = gltf.scene;
                    
                    // Calculate bounding box
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    
                    // Center the model
                    model.position.sub(center);
                    
                    // Position camera based on model size
                    const distance = maxDim * 1.5; // 1.5x the max dimension for good initial view
                    camera.position.set(distance, distance * 0.5, distance);
                    camera.lookAt(0, 0, 0);
                    
                    // Update controls based on model size
                    controls.target.set(0, 0, 0);
                    controls.minDistance = maxDim * 0.1;  // Can zoom to 10% of model size
                    controls.maxDistance = maxDim * 10;   // Can zoom out to 10x model size
                    controls.update();
                    
                    // Update lights to cover larger models
                    directionalLight1.position.set(maxDim, maxDim, maxDim);
                    directionalLight2.position.set(-maxDim, -maxDim, -maxDim);
                    
                    scene.add(model);
                    loadingOverlay.style.display = 'none';
                    
                    console.log('Model loaded - Size:', size, 'Max dimension:', maxDim);
                },
                function(xhr) {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    console.log(percent + '% loaded');
                },
                function(error) {
                    console.error('Error loading model:', error);
                    loadingOverlay.innerHTML = '<div class="text-center text-white"><p class="text-lg">Failed to load model</p></div>';
                }
            );
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        // Handle window resize
        window.addEventListener('resize', function() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    }
    
    // Initialize viewer when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initViewer);
    } else {
        initViewer();
    }
</script>
{% endblock %}
