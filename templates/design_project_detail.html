{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.name }} - Design Project - NexaAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cad-designer.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <a href="/design/projects/" class="inline-flex items-center gap-2 text-sm font-semibold mb-4 transition-all hover:gap-3" style="color: #9d33ff;">
            <i class="bi bi-arrow-left"></i>
            <span>Back to Projects</span>
        </a>

        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl font-bold mb-2 flex items-center gap-3">
                    <i class="bi bi-box" style="color: #e600a5; filter: drop-shadow(0 0 8px rgba(230, 0, 165, 0.5));"></i>
                    <span style="background: linear-gradient(135deg, #8400ff 0%, #e600a5 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">{{ project.name }}</span>
                </h1>
                <p class="text-gray-400">{{ project.original_prompt }}</p>
            </div>
            <div>
                <span class="stage-badge stage-badge-{{ project.stage }}">
                    {{ project.stage|title }}
                </span>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="cad-card mb-8">
        <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-semibold" style="color: #ffffff;">Progress</span>
            <span class="text-sm" style="color: #8a8694;">
                {% if project.stage == 'concept' %}Step 1 of 4
                {% elif project.stage == 'overall_model' %}Step 2 of 4
                {% elif project.stage == 'parts' %}Step 3 of 4
                {% elif project.stage == 'generation' or project.stage == 'completed' %}Step 4 of 4
                {% endif %}
            </span>
        </div>
        <div class="w-full rounded-full h-2" style="background: rgba(132, 0, 255, 0.15);">
            <div class="h-2 rounded-full transition-all duration-500"
                style="background: linear-gradient(90deg, #8400ff 0%, #e600a5 100%); box-shadow: 0 0 12px rgba(132, 0, 255, 0.5); width: {% if project.stage == 'concept' %}25%{% elif project.stage == 'overall_model' %}50%{% elif project.stage == 'parts' %}75%{% elif project.stage == 'generation' or project.stage == 'completed' %}100%{% endif %}">
            </div>
        </div>
    </div>

    <!-- Stage 1: Design Concept -->
    {% if concept %}
    <div id="concept-section" class="cad-card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="cad-section-title" style="margin-bottom: 0;">
                <i class="bi bi-file-earmark-text" style="font-size: 1.5rem; color: #e600a5; filter: drop-shadow(0 0 6px rgba(230, 0, 165, 0.5));"></i>
                Stage 1: Design Concept
            </h2>
            {% if project.stage != 'concept' %}
            <span class="stage-badge stage-badge-complete">‚úì Approved</span>
            {% endif %}
        </div>

        <div class="prose max-w-none">
            <h3 class="text-lg font-semibold mb-2" style="color: #ffffff;">Overview</h3>
            <p class="whitespace-pre-wrap" style="color: #b8b4c5;">{{ concept.overview }}</p>

            <h3 class="text-lg font-semibold mt-4 mb-2" style="color: #ffffff;">Key Features</h3>
            <ul class="list-disc list-inside" style="color: #b8b4c5;">
                {% for feature in concept.key_features %}
                <li>{{ feature }}</li>
                {% endfor %}
            </ul>

            <h3 class="text-lg font-semibold mt-4 mb-2" style="color: #ffffff;">Technical Specifications</h3>
            <p class="whitespace-pre-wrap" style="color: #b8b4c5;">{{ concept.technical_specs }}</p>
        </div>

        {% if project.stage == 'concept' %}
        <div class="flex gap-4 mt-6">
            <button 
                hx-post="/api/design/approve-concept/{{ project.id }}/"
                hx-target="#concept-section"
                hx-swap="innerHTML"
                class="cad-btn-primary flex-1">
                <i class="bi bi-check-lg"></i> Approve & Generate Overall Model
            </button>
            <button 
                onclick="document.getElementById('refine-form-{{ project.id }}').classList.toggle('hidden')"
                class="cad-btn-secondary flex-1">
                <i class="bi bi-arrow-repeat"></i> Refine Concept
            </button>
        </div>
        
        <div id="refine-form-{{ project.id }}" class="mt-4 hidden">
            <form hx-post="/api/design/refine-concept/{{ project.id }}/" hx-target="#concept-section" hx-swap="innerHTML">
                <label class="block text-sm font-semibold mb-2" style="color: #b8b4c5;">Provide feedback to refine the concept:</label>
                <textarea 
                    name="feedback" 
                    rows="3" 
                    placeholder="Example: Make it smaller, use aluminum instead of plastic, add more storage..."
                    class="cad-textarea"
                    required></textarea>
                <button type="submit" class="cad-btn-primary mt-2">
                    Refine Concept
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Stage 2: Overall 3D Model -->
    {% if project.stage == 'overall_model' or project.stage == 'parts' or project.stage == 'generation' or project.stage == 'completed' %}
    <div class="cad-card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="cad-section-title" style="margin-bottom: 0;">
                <i class="bi bi-box" style="font-size: 1.5rem; color: #e600a5; filter: drop-shadow(0 0 6px rgba(230, 0, 165, 0.5));"></i>
                Stage 2: Overall 3D Model
            </h2>
            {% if project.overall_model_approved_at %}
            <span class="stage-badge stage-badge-complete">‚úì Approved</span>
            {% elif project.stage == 'overall_model' %}
            <span class="stage-badge stage-badge-generation">‚è≥ Pending</span>
            {% endif %}
        </div>

        {% if project.stage == 'overall_model' and project.overall_model_status != 'completed' %}

        {% if project.overall_model_status == 'generating' %}
        <!-- Show generating status -->
        <div id="overall-model-result" class="mt-4">
            <div class="workflow-card" style="border-color: rgba(59, 130, 246, 0.4);">
                <p class="font-semibold" style="color: #60a5fa;"><i class="bi bi-hourglass-split"></i> Generating overall model...</p>
                <p class="text-sm mt-1" style="color: #b8b4c5;">This may take 30-60 seconds. You can navigate away and come back.</p>
                <p class="text-xs mt-2" style="color: #60a5fa;">Auto-refreshing every 5 seconds...</p>
                <button onclick="location.reload()" class="cad-btn-primary mt-3">
                    <i class="bi bi-arrow-repeat"></i> Refresh Now
                </button>
            </div>
        </div>
        <script>
            setTimeout(function () { location.reload(); }, 5000);
        </script>

        {% elif project.overall_model_status == 'failed' %}
        <!-- Show failed status with retry -->
        <div id="overall-model-result" class="mt-4">
            <div class="workflow-card" style="border-color: rgba(239, 68, 68, 0.4);">
                <p class="font-semibold" style="color: #f87171;"><i class="bi bi-x-circle"></i> Overall model generation failed</p>
                <p class="text-sm mt-1" style="color: #f87171;">{{ project.overall_model_error|default:"Unknown error" }}</p>
                <button hx-post="/api/design/generate-overall-model/{{ project.id }}/" hx-target="#overall-model-result"
                    hx-swap="innerHTML" class="cad-btn-primary mt-3">
                    <i class="bi bi-arrow-repeat"></i> Retry Generation
                </button>
            </div>

            <!-- Allow correction even on failure -->
            <div class="mt-4 pt-4" style="border-top: 1px solid rgba(132, 0, 255, 0.2);">
                <details>
                    <summary class="cursor-pointer text-sm font-semibold" style="color: #60a5fa;"><i class="bi bi-pencil"></i> I fixed the code (click to submit correction)</summary>
                    <div class="mt-3 p-3 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                        <p class="text-xs mb-2" style="color: #8a8694;">Your corrections help train the AI! Paste the corrected code below:</p>
                        <textarea id="correction-overall_model-{{ project.id }}"
                            class="cad-textarea font-mono text-xs"
                            style="height: 10rem;"
                            placeholder="import cadquery as cq\n\nresult = ...">{{ project.overall_model_ai_code }}</textarea>
                        <button onclick="submitCorrection('{{ project.id }}', 'overall_model')" class="cad-btn-primary mt-2">
                            Submit Correction
                        </button>
                    </div>
                </details>
            </div>
        </div>

        {% else %}
        <!-- Generate button -->
        <p class="mb-4" style="color: #8a8694;">Generate a complete 3D model of your design before breaking it into parts.</p>
        <button hx-post="/api/design/generate-overall-model/{{ project.id }}/" hx-target="#overall-model-result"
            hx-swap="innerHTML" class="cad-btn-primary cad-btn-lg">
            Generate Overall Model ‚Üí
        </button>
        <div id="overall-model-result" class="mt-4"></div>
        {% endif %}

        {% elif project.overall_model_status == 'completed' %}
        <!-- Show generated model -->
        <div id="overall-model-result">
            <div class="workflow-card" style="border-color: rgba(16, 185, 129, 0.4);">
                <p class="font-semibold mb-2" style="color: #34d399;">‚úì Overall model generated!</p>

                <!-- 3D Viewer -->
                {% if project.overall_model_stl_url %}
                <div class="mb-4 rounded-lg overflow-hidden" style="height: 700px; background: rgba(19, 17, 26, 0.8); border: 1px solid rgba(132, 0, 255, 0.2);">
                    <div id="model-viewer-overall" class="w-full h-full"></div>
                </div>
                {% endif %}

                <div class="flex gap-2 mb-4 flex-wrap">
                    {% if project.overall_model_step_url %}
                    <a href="{{ project.overall_model_step_url }}" download class="cad-btn-primary">
                        <i class="bi bi-download"></i> Download STEP
                    </a>
                    {% endif %}
                    {% if project.overall_model_stl_url %}
                    <a href="{{ project.overall_model_stl_url }}" download class="cad-btn-secondary">
                        <i class="bi bi-download"></i> Download STL
                    </a>
                    {% endif %}
                </div>

                <details class="mb-4">
                    <summary class="cursor-pointer font-semibold text-sm" style="color: #8a8694;">View Generated Code</summary>
                    <pre class="mt-2 p-3 rounded overflow-x-auto text-xs" style="background: rgba(0, 0, 0, 0.3); color: #34d399;">{{ project.overall_model_ai_code }}</pre>
                </details>

                <!-- Feedback Section -->
                <div class="mb-4 pt-4" style="border-top: 1px solid rgba(132, 0, 255, 0.2);">
                    <p class="text-sm font-semibold mb-2" style="color: #b8b4c5;"><i class="bi bi-bar-chart"></i> Help improve the AI:</p>
                    <div class="flex gap-2 mb-3 flex-wrap">
                        <button onclick="submitFeedback('{{ project.id }}', 'overall_model', 'good')"
                            class="cad-btn-primary flex-1">
                            <i class="bi bi-check-circle"></i> Perfect!
                        </button>
                        <button onclick="submitFeedback('{{ project.id }}', 'overall_model', 'ok')"
                            class="cad-btn-secondary flex-1">
                            <i class="bi bi-exclamation-circle"></i> Needs Work
                        </button>
                        <button onclick="submitFeedback('{{ project.id }}', 'overall_model', 'bad')"
                            class="cad-btn-tertiary flex-1">
                            <i class="bi bi-x-circle"></i> Failed
                        </button>
                    </div>

                    <details>
                        <summary class="cursor-pointer text-sm font-semibold" style="color: #60a5fa;"><i class="bi bi-pencil"></i> I fixed the code (click to submit correction)</summary>
                        <div class="mt-3 p-3 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <p class="text-xs mb-2" style="color: #8a8694;">Your corrections help train the AI! Paste the corrected code below:</p>
                            <textarea id="correction-overall_model-{{ project.id }}"
                                class="cad-textarea font-mono text-xs"
                                style="height: 10rem;"
                                placeholder="import cadquery as cq\n\nresult = ...">{{ project.overall_model_ai_code }}</textarea>
                            <button onclick="submitCorrection('{{ project.id }}', 'overall_model')" class="cad-btn-primary mt-2">
                                Submit Correction
                            </button>
                        </div>
                    </details>
                </div>

                {% if not project.overall_model_approved_at %}
                <div class="flex gap-2">
                    <button hx-post="/api/design/approve-overall-model/{{ project.id }}/"
                        hx-target="#overall-model-result" hx-swap="innerHTML"
                        class="cad-btn-primary flex-1">
                        <i class="bi bi-check-lg"></i> Approve & Break Into Parts
                    </button>
                    <button hx-post="/api/design/generate-overall-model/{{ project.id }}/"
                        hx-target="#overall-model-result" hx-swap="innerHTML"
                        class="cad-btn-secondary">
                        <i class="bi bi-arrow-repeat"></i> Regenerate
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Stage 3: Part Breakdown -->
    {% if breakdown %}
    <div class="cad-card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="cad-section-title" style="margin-bottom: 0;">
                <i class="bi bi-puzzle" style="font-size: 1.5rem; color: #e600a5; filter: drop-shadow(0 0 6px rgba(230, 0, 165, 0.5));"></i>
                Stage 3: Part Breakdown
            </h2>
            <span class="stage-badge stage-badge-complete">‚úì Approved</span>
        </div>

        <p class="mb-4" style="color: #8a8694;">{{ breakdown.parts|length }} parts identified</p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for part in breakdown.parts %}
            <div class="workflow-card">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="font-bold" style="color: #ffffff;">Part {{ part.part_number }}</h3>
                    <span class="stage-badge {% if part.status == 'completed' %}stage-badge-complete{% elif part.status == 'generating' %}stage-badge-generation{% elif part.status == 'failed' %}stage-badge-concept{% else %}stage-badge-parts{% endif %}" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;">
                        {{ part.status|default:"pending" }}
                    </span>
                </div>
                <p class="text-sm font-semibold mb-2" style="color: #b8b4c5;">{{ part.name }}</p>
                <p class="text-xs mb-2" style="color: #8a8694;">{{ part.description }}</p>
                <div class="text-xs" style="color: #8a8694;">
                    <span class="font-semibold">Method:</span> {{ part.manufacturing_method }}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Generate All Button -->
        {% if project.stage == 'parts' %}
        <div class="mt-6 text-center">
            <form hx-post="/api/design/approve-parts/{{ project.id }}/" hx-target="#generation-status"
                hx-swap="innerHTML" class="inline-block">
                {% csrf_token %}
                <button type="submit" class="cad-btn-primary cad-btn-lg">
                    Start CAD Generation ‚Üí
                </button>
            </form>
            <div id="generation-status" class="mt-4"></div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Stage 4: CAD Generation -->
    {% if project.stage == 'generation' or project.stage == 'completed' %}
    <div class="cad-card mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="cad-section-title" style="margin-bottom: 0;">
                <i class="bi bi-gear" style="font-size: 1.5rem; color: #e600a5; filter: drop-shadow(0 0 6px rgba(230, 0, 165, 0.5));"></i>
                Stage 4: CAD Generation
            </h2>
            {% if project.stage == 'completed' %}
            <span class="stage-badge stage-badge-complete">‚úì Complete</span>
            {% else %}
            <span class="stage-badge stage-badge-generation">In Progress...</span>
            {% endif %}
        </div>

        <p class="mb-6" style="color: #8a8694;">
            Progress: {{ project.generated_parts|default:0 }} / {{ breakdown.parts|length }} parts generated
        </p>

        <!-- Part Generation Cards -->
        <div class="space-y-4">
            {% for part in breakdown.parts %}
            <div class="workflow-card">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold" style="color: #ffffff;">Part {{ part.part_number }}: {{ part.name }}</h3>
                    {% if part.status == 'completed' %}
                    <span class="stage-badge stage-badge-complete">‚úì Generated</span>
                    {% elif part.status == 'generating' %}
                    <span class="stage-badge stage-badge-generation">‚è≥ Generating...</span>
                    {% elif part.status == 'failed' %}
                    <span class="stage-badge stage-badge-concept" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%); border-color: rgba(239, 68, 68, 0.4); color: #f87171;">‚úó Failed</span>
                    {% else %}
                    <button hx-post="/api/design/generate/{{ project.id }}/{{ part.part_number }}/"
                        hx-target="#part-{{ part.part_number }}-result" hx-swap="innerHTML"
                        class="cad-btn-primary">
                        Generate CAD Model
                    </button>
                    {% endif %}
                </div>

                <div id="part-{{ part.part_number }}-result">
                    {% if part.status == 'completed' %}
                    <div class="mt-2 p-4 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <p class="font-semibold mb-2" style="color: #34d399;"><i class="bi bi-check-circle"></i> Part {{ part.part_number }} generated successfully!</p>

                        <div class="flex gap-2 mb-3 flex-wrap">
                            {% if part.step_url %}
                            <a href="{{ part.step_url }}" download class="cad-btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                <i class="bi bi-download"></i> Download STEP
                            </a>
                            {% endif %}
                            {% if part.stl_url %}
                            <a href="{{ part.stl_url }}" download class="cad-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                <i class="bi bi-download"></i> Download STL
                            </a>
                            {% endif %}
                            <button onclick="showPrinterSelector('{{ project.id }}', {{ part.part_number }}, '{{ part.name }}')"
                                class="cad-btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                <i class="bi bi-printer"></i> Send to Printer
                            </button>
                        </div>

                        {% if part.cadquery_code %}
                        <details class="text-sm">
                            <summary class="cursor-pointer font-semibold" style="color: #8a8694;">View Generated Code</summary>
                            <pre class="mt-2 p-3 rounded overflow-x-auto text-xs" style="background: rgba(0, 0, 0, 0.3); color: #34d399;">{{ part.cadquery_code }}</pre>
                        </details>
                        {% endif %}
                    </div>
                    {% elif part.status == 'failed' %}
                    <div class="mt-2 p-4 rounded-lg" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                        <p class="font-semibold mb-2" style="color: #f87171;"><i class="bi bi-x-circle"></i> Generation failed</p>
                        {% if part.generation_error %}
                        <p class="text-sm mb-3" style="color: #f87171;">{{ part.generation_error }}</p>
                        {% endif %}
                        <button hx-post="/api/design/generate/{{ project.id }}/{{ part.part_number }}/"
                            hx-target="#part-{{ part.part_number }}-result" hx-swap="innerHTML"
                            class="cad-btn-primary">
                            <i class="bi bi-arrow-repeat"></i> Retry Generation
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Project Info -->
    <div class="workflow-card">
        <h3 class="font-bold mb-4" style="color: #ffffff;">Project Information</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <span style="color: #8a8694;">Created:</span>
                <span class="font-semibold" style="color: #ffffff;">{{ project.created_at|date:"M d, Y H:i" }}</span>
            </div>
            <div>
                <span style="color: #8a8694;">Last Updated:</span>
                <span class="font-semibold" style="color: #ffffff;">{{ project.updated_at|date:"M d, Y H:i" }}</span>
            </div>
            <div>
                <span style="color: #8a8694;">Status:</span>
                <span class="font-semibold" style="color: #ffffff;">{{ project.status|title }}</span>
            </div>
            {% if project.completed_at %}
            <div>
                <span style="color: #8a8694;">Completed:</span>
                <span class="font-semibold" style="color: #ffffff;">{{ project.completed_at|date:"M d, Y H:i" }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Printer Selector Modal -->
<div id="printerModal" class="fixed inset-0 hidden flex items-center justify-center z-50" style="background: rgba(19, 17, 26, 0.95); backdrop-filter: blur(12px);">
    <div class="cad-card" style="max-width: 28rem; width: 100%; margin: 1rem;">
        <h3 class="text-xl font-bold mb-4" style="color: #ffffff;">Send to Printer</h3>
        <p class="text-sm mb-4" style="color: #b8b4c5;">Part: <span id="modalPartName"></span></p>

        <div id="printerList" class="space-y-2 mb-4">
            <!-- Printers will be loaded here -->
        </div>

        <div id="sendResult" class="mb-4"></div>

        <div class="flex gap-2">
            <button onclick="closePrinterModal()" class="flex-1 px-4 py-2 rounded-lg transition" style="border: 1px solid rgba(132, 0, 255, 0.3); color: #ffffff; background: rgba(255, 255, 255, 0.05);">
                Cancel
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
    // Configure HTMX
    document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
    });

    let currentProjectId = null;
    let currentPartNumber = null;

    function showPrinterSelector(projectId, partNumber, partName) {
        currentProjectId = projectId;
        currentPartNumber = partNumber;

        document.getElementById('modalPartName').textContent = partName;
        document.getElementById('printerModal').classList.remove('hidden');
        document.getElementById('sendResult').innerHTML = '';

        // Load available printers
        fetch('/api/printers')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const printerCards = doc.querySelectorAll('[href*="/printers/edit/"]');
                const printerList = document.getElementById('printerList');

                if (printerCards.length === 0) {
                    printerList.innerHTML = '<p class="text-sm" style="color: #8a8694;">No printers configured. <a href="/printers/add" style="color: #8400ff;">Add a printer</a></p>';
                    return;
                }

                let buttons = '';
                printerCards.forEach(card => {
                    const href = card.getAttribute('href');
                    const printerId = href.split('/').pop();
                    const printerName = card.closest('.cad-card, .workflow-card, [style*="background"]').querySelector('h3').textContent;

                    buttons += `
                        <button 
                            onclick="sendToPrinter('${printerId}', '${printerName}')"
                            class="cad-btn-primary cad-btn-full"
                        >
                            üñ®Ô∏è ${printerName}
                        </button>
                    `;
                });

                printerList.innerHTML = buttons;
            })
            .catch(error => {
                document.getElementById('printerList').innerHTML = '<p class="text-sm" style="color: #ef4444;">Failed to load printers</p>';
            });
    }

    function sendToPrinter(printerId, printerName) {
        const resultDiv = document.getElementById('sendResult');
        resultDiv.innerHTML = '<p class="text-sm" style="color: #8a8694;">Sending to ' + printerName + '...</p>';

        fetch(`/api/design/send-to-printer/${currentProjectId}/${currentPartNumber}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `printer_id=${printerId}`
        })
            .then(response => response.text())
            .then(html => {
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = '<div class="p-3 rounded" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;">Error: ' + error + '</div>';
            });
    }

    function closePrinterModal() {
        document.getElementById('printerModal').classList.add('hidden');
    }

    // 3D Model Viewer using Three.js
    function init3DViewer(containerId, modelUrl) {
        const container = document.getElementById(containerId);
        if (!container || !modelUrl) return;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x13111a);
        scene.fog = new THREE.Fog(0x13111a, 10000, 100000);

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.01, 500000);
        camera.position.set(200, 200, 200);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.outputEncoding = THREE.sRGBEncoding;
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const keyLight = new THREE.DirectionalLight(0xffffff, 1.0);
        keyLight.position.set(5, 10, 7.5);
        keyLight.castShadow = true;
        keyLight.shadow.mapSize.width = 2048;
        keyLight.shadow.mapSize.height = 2048;
        scene.add(keyLight);

        const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
        fillLight.position.set(-5, 0, -5);
        scene.add(fillLight);

        const rimLight = new THREE.DirectionalLight(0xffffff, 0.3);
        rimLight.position.set(0, -10, -5);
        scene.add(rimLight);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.3);
        scene.add(hemiLight);

        const gridHelper = new THREE.GridHelper(10000, 100, 0x8400ff, 0x3d1f5c);
        gridHelper.material.opacity = 0.15;
        gridHelper.material.transparent = true;
        scene.add(gridHelper);

        const axesHelper = new THREE.AxesHelper(1000);
        axesHelper.material.linewidth = 2;
        scene.add(axesHelper);

        const loader = new THREE.STLLoader();
        loader.load(modelUrl, function (geometry) {
            const material = new THREE.MeshStandardMaterial({
                color: 0x8400ff,
                metalness: 0.4,
                roughness: 0.3,
                envMapIntensity: 1.0,
                flatShading: false
            });

            const edgeMaterial = new THREE.LineBasicMaterial({ color: 0xe600a5, linewidth: 1, opacity: 0.6, transparent: true });
            const edges = new THREE.EdgesGeometry(geometry, 15);
            const edgeLines = new THREE.LineSegments(edges, edgeMaterial);

            const mesh = new THREE.Mesh(geometry, material);

            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            mesh.position.sub(center);

            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            scene.add(edgeLines);
            edgeLines.position.copy(mesh.position);

            const size = new THREE.Vector3();
            geometry.boundingBox.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
            cameraZ *= 2.5;
            camera.position.set(cameraZ, cameraZ * 0.7, cameraZ);
            camera.lookAt(0, 0, 0);
            
            controls.minDistance = maxDim * 0.1;
            controls.maxDistance = maxDim * 20;
        });

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.rotateSpeed = 0.5;
        controls.zoomSpeed = 0.8;
        controls.panSpeed = 0.5;
        controls.minDistance = 1;
        controls.maxDistance = 50000;
        controls.enablePan = true;
        controls.screenSpacePanning = true;

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', function () {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        {% if project.overall_model_stl_url %}
        init3DViewer('model-viewer-overall', '{{ project.overall_model_stl_url }}');
        {% endif %}
    });

    function submitFeedback(projectId, modelType, rating) {
        fetch(`/api/design/feedback/${projectId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ model_type: modelType, rating: rating })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Thank you for your feedback! This helps improve the AI.');
                }
            })
            .catch(error => console.error('Feedback error:', error));
    }

    function submitCorrection(projectId, modelType) {
        const textarea = document.getElementById(`correction-${modelType}-${projectId}`);
        if (!textarea) {
            alert('‚ùå Error: Could not find correction textarea.');
            return;
        }
        const correctedCode = textarea.value;
        if (!correctedCode.trim()) {
            alert('Please enter the corrected code.');
            return;
        }
        showCorrectionTypeDialog(projectId, modelType, correctedCode);
    }

    function showCorrectionTypeDialog(projectId, modelType, correctedCode) {
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(19, 17, 26, 0.95); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 9999;';
        modal.innerHTML = `
            <div class="cad-card" style="max-width: 500px;">
                <h3 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #ffffff;">
                    üéØ What type of correction is this?
                </h3>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="submitWithType('${projectId}', '${modelType}', 'code_fix')" 
                            class="cad-btn-primary cad-btn-full" style="margin-bottom: 12px; text-align: left; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <div style="font-size: 18px; margin-bottom: 4px;">üîß Code Fix</div>
                        <div style="font-size: 13px; opacity: 0.9;">I fixed syntax errors or made it executable</div>
                    </button>
                    
                    <button onclick="submitWithType('${projectId}', '${modelType}', 'model_improvement')" 
                            class="cad-btn-primary cad-btn-full" style="text-align: left; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div style="font-size: 18px; margin-bottom: 4px;">‚≠ê Model Improvement</div>
                        <div style="font-size: 13px; opacity: 0.9;">I improved the design quality</div>
                    </button>
                </div>
                
                <button onclick="closeCorrectionDialog()" 
                        style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(132, 0, 255, 0.3); color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
            </div>
        `;
        modal.id = 'correction-type-modal';
        modal.onclick = (e) => { if (e.target === modal) closeCorrectionDialog(); };
        document.body.appendChild(modal);
        window.currentCorrectedCode = correctedCode;
    }

    function closeCorrectionDialog() {
        const modal = document.getElementById('correction-type-modal');
        if (modal) modal.remove();
        window.currentCorrectedCode = null;
    }

    function submitWithType(projectId, modelType, correctionType) {
        const correctedCode = window.currentCorrectedCode;
        if (!correctedCode) {
            alert('‚ùå Error: Corrected code not found.');
            return;
        }
        closeCorrectionDialog();
        fetch(`/api/design/feedback/${projectId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                model_type: modelType,
                rating: 'corrected',
                corrected_code: correctedCode,
                correction_type: correctionType
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const textarea = document.getElementById(`correction-${modelType}-${projectId}`);
                    if (textarea) textarea.value = '';
                    alert('‚úÖ Correction submitted! Thank you for helping improve the AI.');
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Correction error:', error);
                alert('‚ùå Error submitting correction. Please try again.');
            });
    }
</script>

<!-- Three.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

{% endblock %}
